name: üöÄ Deploy Frontend to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üßπ Checkout code
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: üì¶ Install dependencies
        run: |
          echo "üü° Installing dependencies..."
          cd jarvis-frontend
          npm ci
          echo "‚úÖ Dependencies installed successfully."

      - name: üèóÔ∏è Build project
        run: |
          echo "üü° Building project..."
          cd jarvis-frontend
          npm run build
          echo "‚úÖ Build complete. Contents of dist folder:"
          ls -la dist

      - name: üß© Debug SSH Key presence
        run: |
          echo "üîç Checking SSH key variable..."
          if [ -z "${{ secrets.FRONTEND_DEPLOY_KEY }}" ]; then
            echo "‚ùå SSH key secret is missing or not passed!"
            exit 1
          else
            echo "‚úÖ SSH key secret detected."
            echo "üîê First 100 chars of key:"
            echo "${{ secrets.FRONTEND_DEPLOY_KEY }}" | head -c 100
          fi
          echo "üåç EC2 Host: ${{ secrets.EC2_HOST }}"
          echo "üë§ EC2 User: ${{ secrets.EC2_USER }}"
        shell: bash

      - name: üåê Pre-check SSH connection manually
        run: |
          echo "üîç Testing raw SSH connectivity..."
          echo "${{ secrets.FRONTEND_DEPLOY_KEY }}" > /tmp/ec2_key.pem
          chmod 600 /tmp/ec2_key.pem
          echo "‚è≥ Trying to connect to ${{ secrets.EC2_HOST }} on port 22..."
          ssh -vvv -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 -i /tmp/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo ‚úÖ SSH connected successfully." || (echo "‚ùå SSH connection test failed!" && exit 1)
        shell: bash

      - name: üì§ Deploy to EC2 (SCP)
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.FRONTEND_DEPLOY_KEY }}
          source: "jarvis-frontend/dist/*"
          target: "/usr/share/nginx/html"
          port: 22
          timeout: 60s
          command_timeout: 30s
          debug: true
          overwrite: true
          strip_components: 1
          rm: true
          proxy_port: 22
          strict: false

      - name: üöÄ Verify & restart Nginx
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.FRONTEND_DEPLOY_KEY }}
          script_stop: true
          script: |
            echo "üü° Checking Nginx directory permissions..."
            ls -ld /usr/share/nginx/html
            echo "üü° Listing files..."
            ls -la /usr/share/nginx/html
            echo "üü° Setting permissions..."
            sudo chown -R ubuntu:www-data /usr/share/nginx/html
            sudo chmod -R 775 /usr/share/nginx/html
            sudo systemctl restart nginx
            echo "‚úÖ Nginx restarted successfully."
